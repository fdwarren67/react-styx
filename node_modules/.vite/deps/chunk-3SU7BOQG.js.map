{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/support/TitleCreator.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.32/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../chunks/tslib.es6.js\";import t from\"../../core/Accessor.js\";import{createTask as s}from\"../../core/asyncUtils.js\";import i from\"../../core/Collection.js\";import{property as r}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/has.js\";import\"../../core/Logger.js\";import\"../../core/RandomLCG.js\";import{subclass as a}from\"../../core/accessorSupport/decorators/subclass.js\";import{featureHasFields as o,extractSubstitutionTemplatesFromString as n}from\"./fieldUtils.js\";import{loadArcade as l}from\"../../support/arcadeOnDemand.js\";const p=\"relationships/\",c=\"expression/\";let d=class extends t{constructor(e){super(e),this._featureUtils=null,this.effectivePopupTemplate=null}get _arcadeTask(){if(this.expressionsUsedInTitle.length>0){return this._get(\"_arcadeTask\")||s((()=>l()))}return null}get featureUtilsPromise(){return this._get(\"featureUtilsPromise\")??import(\"../../widgets/Feature/support/featureUtils.js\").then((e=>this._featureUtils=e))}get calculatedExpressions(){const e=new i;if(!this.expressionsUsedInTitle.length)return e;if(!this._arcadeTask?.value){for(const t of this.expressionsUsedInTitle??[])e.push({name:t.name,invalid:!0});return e}for(const t of this.expressionsUsedInTitle)try{const s=this._arcadeTask.value.arcade.parseScript(t.expression,[\"$layer\",\"$map\",\"$datastore\"]);if(s.isAsync){e.push({name:t.name,invalid:!0});break}e.push({name:t.name,syntax:s,invalid:!1,func:this._arcadeTask.value.arcade.compileScript(s,{vars:{$feature:\"any\"}})})}catch{e.push({name:t.name,invalid:!0});break}return e}get expressionsUsedInTitle(){let e=this.effectivePopupTemplate?.title??\"\";return\"string\"!=typeof e?[]:(e=e.toLowerCase(),this.effectivePopupTemplate?.expressionInfos?.filter((t=>e.includes(`{expression/${t.name.toLowerCase()}}`)))??[])}get fieldInfoMap(){return this._featureUtils?this._createFieldInfoMap(this._featureUtils.getAllFieldInfos(this.effectivePopupTemplate)):null}get hasBadExpressions(){return this.calculatedExpressions.some((e=>!0===e.invalid))}get requiredFields(){const e=new Set;if(this._arcadeTask?.value&&!this.hasBadExpressions)for(const s of this.calculatedExpressions?.toArray()??[])try{const t=this._arcadeTask.value.arcade.extractFieldLiterals(s.syntax);for(const s of t){const t=s.split(\".\"),i=this.fieldsIndex.get(t.at(-1)??\"\");i&&e.add(i.name)}}catch{}const t=this._extractFieldNames(this.workingTitle);for(const s of t){const t=this.fieldsIndex.get(s);t&&e.add(t.name)}return e}get titleFromDisplayField(){let e=\"\";return this.displayField&&(e=this.fieldsIndex.get(this.displayField)?.name??\"\"),e||(e=this.fieldsIndex.get(this.objectIdField)?.name??\"\"),e?`{${e}}`:\"\"}get workingTitle(){const e=this.effectivePopupTemplate?this.effectivePopupTemplate.title:\"\";return\"\"===e||null==e||this.hasBadExpressions||\"string\"!=typeof e?this.titleFromDisplayField:e}async getTitle(e,t,s){try{const{attributes:i}=t,r=s?.timeZone??\"system\",[{substituteFieldsInLinksAndAttributes:a}]=await Promise.all([this.featureUtilsPromise,this._arcadeTask?.promise]);if(s.fetchMissingFields&&(t=await this._checkAndReQueryGraphic(e,t)),this.workingTitle&&this.fieldInfoMap){const s=this._createFormattedAttributes(e,t,r).global;return a({attributes:i,expressionAttributes:null,fieldInfoMap:this.fieldInfoMap,globalAttributes:s,layer:e,text:this.workingTitle})}return\"\"}catch{}return\"\"}async _checkAndReQueryGraphic(e,t){const s=t.getObjectId();if(null==s)return t;if(!o(this.requiredFields,t)){const t=e.createQuery();t.where=\"1=1\",t.outFields=[...this.requiredFields],t.objectIds=[s];const i=await e.queryFeatures(t);if(1===i?.features.length)return i.features[0]}return t}_createFieldInfoMap(e){const t=new Map;if(!e)return t;for(const s of e){if(!s.fieldName)continue;const e=this.fieldsIndex.get(s.fieldName),i=e?.name??s.fieldName;s.fieldName=i,t.set(i.toLowerCase(),s)}return t}_createFormattedAttributes(e,t,s=\"system\"){const i=this.effectivePopupTemplate?.fieldInfos??[],r={};if(!this._featureUtils)return{};if(!this.hasBadExpressions&&this.calculatedExpressions.length>0&&this._arcadeTask?.value){const s=this._arcadeTask.value.Feature.createFromGraphicLikeObject(t.geometry,t.attributes,e,null);for(const e of this.calculatedExpressions)try{r[`expression/${e.name}`]=e.func({vars:{$feature:s}})}catch{}}const a={...t.attributes,...r};return{global:this._featureUtils.formatAttributes({fieldInfos:i,attributes:a,graphic:t,timeZone:s,layer:e,fieldInfoMap:this.fieldInfoMap}),content:[]}}_extractFieldNames(e){return n(e).filter((e=>!(0===e.indexOf(p)||0===e.indexOf(c))))}};e([r({readOnly:!0})],d.prototype,\"_arcadeTask\",null),e([r()],d.prototype,\"_featureUtils\",void 0),e([r({readOnly:!0})],d.prototype,\"featureUtilsPromise\",null),e([r({readOnly:!0})],d.prototype,\"calculatedExpressions\",null),e([r()],d.prototype,\"displayField\",void 0),e([r()],d.prototype,\"effectivePopupTemplate\",void 0),e([r()],d.prototype,\"expressionsUsedInTitle\",null),e([r()],d.prototype,\"fieldsIndex\",void 0),e([r()],d.prototype,\"fieldInfoMap\",null),e([r()],d.prototype,\"fields\",void 0),e([r()],d.prototype,\"objectIdField\",void 0),e([r()],d.prototype,\"requiredFields\",null),d=e([a(\"esri.layers.support.TitleCreator\")],d);const u=d;export{u as default};\n"],
  "mappings": "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",
  "names": ["d", "t", "s", "r", "a", "e"]
}
